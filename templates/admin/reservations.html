{% extends "admin/layout.html" %}

{% block title %}ì˜ˆì•½ ëª©ë¡{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='flatpickr/flatpickr.min.css') }}">

<style>
  .flatpickr-calendar.inline,
  .flatpickr-calendar.open {
    width: auto !important;
  }

  .flatpickr-calendar .flatpickr-months {
    display: flex !important;
    justify-content: space-between;
  }

  .flatpickr-calendar .flatpickr-innerContainer {
    display: flex !important;
  }

  .flatpickr-calendar .flatpickr-rContainer {
    display: block !important;
  }
</style>

<div class="container mt-4">
  <h2 class="mb-2">ì˜ˆì•½ ê´€ë¦¬ í˜ì´ì§€</h2>
  <p class="mb-4 text-muted">ê²€ìƒ‰ ê²°ê³¼: <strong>{{ total_count }}</strong>ê±´</p>

  <div class="mb-3 d-flex justify-content-between">
    <div>
      <form method="get" action="{{ url_for('admin_reservation.admin_reservations') }}" class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
        <a href="{{ url_for('admin_reservation.admin_reservations') }}" class="btn btn-secondary">ì´ˆê¸°í™”</a>
      </form>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="/admin/reservation/create">
        â• ì˜ˆì•½ ì¶”ê°€
      </a>
      <a class="btn btn-success"
         href="{{ url_for('admin_reservation.download_reservations_excel',
              customer_name=customer_name, reservation_code=reservation_code,
              departure_date=departure_date, date_range=date_range,
              destination=destination, status=status) }}">
        ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      </a>
    </div>
  </div>

  <form class="row g-3 mb-4" method="get">
    <div class="col-md-2">
      <label for="departureDate" class="form-label">ì¶œë°œì¼</label>
      <input type="text" class="form-control" id="departureDate" name="departure_date" placeholder="YYYY-MM-DD" value="{{ departure_date }}">
    </div>
    <div class="col-md-3">
      <label for="dateRange" class="form-label">ì¶œë°œ ~ ê·€êµ­ì¼</label>
      <input type="text" class="form-control" id="dateRange" name="date_range" placeholder="ë‚ ì§œ ë²”ìœ„ ì„ íƒ" value="{{ date_range }}">
    </div>
    <div class="col-md-2">
      <label for="customerName" class="form-label">ê³ ê°ëª…</label>
      <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" value="{{ customer_name }}">
    </div>
    <div class="col-md-2">
      <label for="reservationCode" class="form-label">ì˜ˆì•½ë²ˆí˜¸</label>
      <input type="text" class="form-control" id="reservationCode" name="reservation_code" value="{{ reservation_code }}">
    </div>
    <div class="col-md-2">
      <label for="destination" class="form-label">ì—¬í–‰ì§€</label>
      <input type="text" class="form-control" id="destination" name="destination" placeholder="ì˜ˆ: íƒœêµ­/í‘¸ì¼“" value="{{ destination }}">
    </div>
    <div class="col-md-2">
      <label for="status" class="form-label">ìƒíƒœ</label>
      <select class="form-select" id="status" name="status">
        <option value="">ì „ì²´</option>
        <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>í™•ì •</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>ëŒ€ê¸°</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>ì·¨ì†Œ</option>
      </select>
    </div>
  </form>

  <table class="table table-hover table-bordered text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>ê²¬ì ë²ˆí˜¸</th>
        <th>ì˜ˆì•½ì¼</th>
        <th>ì˜ˆì•½ë²ˆí˜¸</th>
        <th>ê³ ê°ëª…</th>
        <th>ì—¬í–‰ì§€</th>
        <th>ìƒí’ˆëª…</th>
        <th>ì—¬í–‰ê¸°ê°„</th>
        <th>ì¸ì›</th>
        <th>í•­ê³µ ì •ë³´</th>
        <th>ë¦¬ì¡°íŠ¸ ì •ë³´</th>
        <th>ìƒíƒœ</th>
        <th>ìƒì„¸ë³´ê¸°</th>
      </tr>
    </thead>
    <tbody>
      {% for res in reservations %}
      <tr>
        <td>{{ res.quote_no }}</td>
        <td>{{ res.created_at.strftime('%Y-%m-%d') }}</td>
        <td>{{ res.reservation_no }}</td>
        <td>{{ res.customer_name }}</td>
        <td>{{ res.destination }}</td>
        <td>{{ res.product_name }}</td>
        <td>{{ res.departure_date }} ~ {{ res.return_date }}</td>
        <td>{{ res.total_people }}ëª…<br>(ì„±ì¸: {{ res.adult }}, ì•„ë™: {{ res.child }}, ìœ ì•„: {{ res.infant }})</td>
        <td>{{ res.flight_status }}<br>{{ res.departure_time }} ~ {{ res.return_time }}</td>
        <td>{{ res.resort_status }}<br>{{ res.resort_styles }}<br>{{ res.resort_name }}</td>
        <td>
          {% if res.status == 'confirmed' %}
            <span class="badge rounded-pill bg-success px-3 py-2">í™•ì •</span>
          {% elif res.status == 'pending' %}
            <span class="badge rounded-pill bg-warning text-dark border border-dark px-3 py-2">ëŒ€ê¸°</span>
          {% elif res.status == 'cancelled' %}
            <span class="badge rounded-pill bg-danger px-3 py-2">ì·¨ì†Œ</span>
          {% endif %}
        </td>
        <td><a href="/admin/reservation/{{ res.id }}" class="btn btn-sm btn-primary">ìƒì„¸ë³´ê¸°</a></td>
      </tr>
      {% else %}
      <tr>
        <td colspan="12">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pagination.pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_reservation.admin_reservations', page=pagination.prev_num,
          customer_name=customer_name, reservation_code=reservation_code, departure_date=departure_date,
          date_range=date_range, destination=destination, status=status) }}">ì´ì „</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">ì´ì „</span></li>
      {% endif %}

      {% for p in range(1, pagination.pages + 1) %}
      <li class="page-item {% if p == pagination.page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('admin_reservation.admin_reservations', page=p,
          customer_name=customer_name, reservation_code=reservation_code, departure_date=departure_date,
          date_range=date_range, destination=destination, status=status) }}">{{ p }}</a>
      </li>
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_reservation.admin_reservations', page=pagination.next_num,
          customer_name=customer_name, reservation_code=reservation_code, departure_date=departure_date,
          date_range=date_range, destination=destination, status=status) }}">ë‹¤ìŒ</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">ë‹¤ìŒ</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<script src="{{ url_for('static', filename='flatpickr/flatpickr.min.js') }}"></script>
<script src="{{ url_for('static', filename='flatpickr/l10n/ko.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#departureDate", {
      dateFormat: "Y-m-d",
      locale: "ko"
    });
    flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      locale: "ko",
      showMonths: 2
    });
  });
</script>
{% endblock %}
